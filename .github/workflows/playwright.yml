name: Playwright Tests (.NET)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Cache NuGet
        id: nuget-cache
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('PlaywrightTests/PlaywrightTests.csproj') }}
          restore-keys: |
            playwright-browsers-${{ runner.os }}-

      - name: Install/Update Playwright CLI
        run: |
          dotnet tool update --global Microsoft.Playwright.CLI || dotnet tool install --global Microsoft.Playwright.CLI
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Restore and build
        run: |
          dotnet restore
          dotnet build PlaywrightTests/PlaywrightTests.csproj --configuration Debug

      - name: Ensure Playwright browsers installed (install only if missing)
        run: |
          set -euo pipefail
          echo "Playwright cache hit: ${{ steps.playwright-cache.outputs.cache-hit }}"
          # check for chromium headless_shell; if not present install browsers
          shopt -s nullglob
          files=(~/.cache/ms-playwright/*/chrome-linux/headless_shell)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No Playwright browser executable found. Installing browsers..."
            playwright install --with-deps
          else
            echo "Playwright browsers present. Skipping install."
          fi

      - name: Run .NET Playwright tests
        run: dotnet test PlaywrightTests/PlaywrightTests.csproj --logger:"console;verbosity=detailed"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/TestResults/*.trx'
          retention-days: 30
